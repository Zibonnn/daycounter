!function(){var e,t,n,a,i,o,c,s,r=document.getElementById("counters"),d=document.getElementById("no-counters"),l=document.getElementById("add-counter-btn"),u=document.getElementById("add-counter"),m=document.getElementById("close-modal"),v=document.getElementById("modal-submit"),g=document.getElementById("event-name"),f=document.getElementById("event-date"),y=document.getElementById("event-name-error"),h=document.getElementById("event-date-error"),p=document.getElementById("counter-deleted"),E=document.getElementById("undo-delete"),L=document.getElementById("settings-toggle"),I=document.getElementById("settings"),B=document.getElementById("setting-size-list"),T=document.getElementById("setting-scheme-list"),D=document.getElementById("settings-save"),w=!1;picker=new Pikaday({field:document.getElementById("event-date"),format:"YYYY-MM-D"});var M=function(e,t){e.value="",t.value=""},N=function(e,t){e.classList.remove("active"),t.classList.remove("active")},C=function(e){if(!/^\d{4}\-\d{2}\-\d{1,2}$/.test(e))return!1;var t=e.split("-"),n=parseInt(t[0]),a=parseInt(t[1]),i=parseInt(t[2]);if(n<1e3||n>3e3||a<=0||a>12)return!1;var o=[31,28,31,30,31,30,31,31,30,31,30,31];return(n%400===0||n%100!==0&&n%4===0)&&(o[1]=29),i>0&&i<=o[a-1]},S=function(e){var t=864e5,n=new Date;n.setHours(0,0,0,0),currentISO=n.toISOString();var a=new Date(e).toISOString(),i=new Date(currentISO),o=new Date(a),c={days:null,type:null,original:null};return o>i?(c.days=Math.round((o.getTime()-i.getTime())/t),c.type="Days Until"):(c.days=Math.round((i.getTime()-o.getTime())/t),c.type="Days Since"),0===c.days&&(c.days="Today",c.type="<br />"),c.original=e,c},k=function(){var e=document.getElementsByClassName("counter");if(c={},e.length>0){for(var t=0;t<e.length;t++)e[t].id="counter-"+(t+1),c["counter"+(t+1)]={event:e[t].children[2].innerHTML,original:e[t].children[7].innerHTML};"active"===d.className&&(d.className="")}else d.className="active"},b=function(e,t,n,a){var i=document.createElement("li");return i.classList.add("counter"),cDate=moment(a).format("ddd, ll"),i.innerHTML='<div class="counter-move"><a class="counter-mover" data-direction="back" href="#"><i class="fa fa-chevron-left" aria-hidden="true"></i></a><a class="counter-mover" data-direction="forward" href="#"><i class="fa fa-chevron-right" aria-hidden="true"></i></a></div><a class="counter-delete transition" href="#"><i class="fa fa-times" aria-hidden="true"></i></a><h3>'+e+'</h3><span class="event-days">'+t+"</span><p>"+n+'</p><span class="event-original">'+cDate+'</span><a class="counter-edit transition" href="#">Edit Counter</a><span class="event-original-hidden">'+a+"</span>",r.appendChild(i),i},H=function(){chrome.storage.sync.remove("counters",function(){chrome.storage.sync.set({counters:c},function(){console.log("Counters updated.")})})},O=function(){chrome.storage.sync.get("counters",function(e){for(var t in e.counters)if(e.counters.hasOwnProperty(t)){var n=e.counters[t],a=S(n.original);b(n.event,a.days,a.type,n.original)}k(),x()})},x=function(){e=document.getElementsByClassName("counter-edit"),t=document.getElementsByClassName("counter-delete"),moveCounters=document.getElementsByClassName("counter-mover");for(var n=0;n<e.length;n++)Y(e[n]);for(var a=0;a<t.length;a++)z(t[a]);for(var i=0;i<moveCounters.length;i++)A(moveCounters[i])},Y=function(e){e.addEventListener("click",function(e){e.preventDefault(),o=this.parentNode,w=!0,picker.setMoment(moment(o.children[7].innerHTML)),document.getElementById("modal-header-title").innerHTML="Edit Day Counter",document.getElementById("modal-submit").value="Save Day Counter",document.getElementById("event-name").value=o.children[2].innerHTML,document.getElementById("event-date").value=o.children[7].innerHTML,u.classList.add("active")})},z=function(e){e.addEventListener("click",function(e){var t=this.parentNode;a=parseInt(t.id.split("-")[1]),n=t.parentNode.removeChild(t),p.classList.add("active"),window.clearTimeout(i),i=window.setTimeout(function(){p.classList.remove("active"),k(),H()},5e3)})},A=function(e){e.addEventListener("click",function(e){var t=this.dataset.direction,n=parseInt(this.parentNode.parentNode.id.split("-")[1]);P(n,t)})},P=function(e,t){var n=document.getElementById("counter-"+(e+1)),a=document.getElementById("counter-"+(e-1)),i=document.getElementById("counter-"+e);null===a&&"back"===t||null===n&&"forward"===t||("forward"===t?n.parentNode.insertBefore(i,n.nextSibling):a.parentNode.insertBefore(i,a),k(),H())},U=function(){chrome.storage.sync.get("settings",function(e){"undefined"!=typeof e.settings&&(B.value=e.settings.counterSize,T.value=e.settings.counterScheme,document.documentElement.className=T.value,r.className=B.value,window.setTimeout(function(){document.documentElement.style.transition="0.5s ease all",document.body.style.transition="0.5s ease all"},500))})},$=function(){chrome.storage.sync.remove("settings",function(){chrome.storage.sync.set({settings:s},function(){console.log("Settings updated."),U()})})},j=function(){O(),U(),l.addEventListener("click",function(e){picker.gotoDate(new Date),e.preventDefault(),u.classList.add("active"),document.getElementById("modal-header-title").innerHTML="Add a New Day Counter",document.getElementById("modal-submit").value="Add Day Counter",document.body.classList.add("active")}),m.addEventListener("click",function(e){e.preventDefault(),u.classList.remove("active"),M(g,f),N(y,h),document.body.classList.remove("active")}),v.addEventListener("click",function(){var e=g.value,t=f.value,n=!1;if(""===e||null===e?(y.classList.add("active"),n=!0):y.classList.remove("active"),""!==t&&null!==t&&C(t)?h.classList.remove("active"):(h.classList.add("active"),n=!0),!n){var a=S(t);if(w)o.children[2].innerHTML=e,o.children[3].innerHTML=a.days,o.children[4].innerHTML=a.type,o.children[5].innerHTML=moment(a.original).format("ddd, ll"),o.children[7].innerHTML=a.original,o=null,w=!1;else{var i=b(e,a.days,a.type,a.original);Y(i.children[6]),z(i.children[1]),A(i.children[0].children[0]),A(i.children[0].children[1])}k(),H(),u.classList.remove("active"),document.body.classList.remove("active"),M(g,f),N(y,h)}}),E.addEventListener("click",function(e){if(e.preventDefault(),null!==n&&a>0){if(1==a||0===document.getElementsByClassName("counter").length)r.prepend(n);else{var t=document.getElementById("counter-"+(a-1));t.nextSibling?t.parentNode.insertBefore(n,t.nextSibling):r.appendChild(n)}p.classList.remove("active"),n=null,a=null,window.clearTimeout(i),k(),H()}}),L.addEventListener("click",function(){this.classList.contains("active")?(this.classList.remove("active"),I.classList.remove("active")):(this.classList.add("active"),I.classList.add("active"))}),D.addEventListener("click",function(e){e.preventDefault(),s={},s.counterSize=B.options[B.selectedIndex].value,s.counterScheme=T.options[T.selectedIndex].value,$()})};document.addEventListener("DOMContentLoaded",function(){j()})}();