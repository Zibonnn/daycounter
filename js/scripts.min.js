!function(){var e,t,n,a,s=document.getElementById("counters"),i=document.getElementById("no-counters"),o=document.getElementById("add-counter-btn"),r=document.getElementById("add-counter"),d=document.getElementById("close-modal"),l=document.getElementById("modal-submit"),c=document.getElementById("event-name"),m=document.getElementById("event-date"),u=document.getElementById("event-recurring"),v=document.getElementById("event-name-error"),g=document.getElementById("event-date-error"),y=document.getElementById("delete-counter"),f=document.getElementById("delete-cancel"),E=document.getElementById("delete-confirm"),p=document.getElementById("settings-toggle"),B=document.getElementById("settings"),L=document.getElementById("setting-size-list"),I=document.getElementById("setting-scheme-list"),h=document.getElementById("setting-visible-list"),Y=document.getElementById("settings-save"),M=new Pikaday({field:document.getElementById("event-date"),format:"YYYY-MM-D"}),D=(Sortable.create(s,{animation:150,onEnd:function(e){C()}}),function(){c.value="",m.value=""}),b=function(){v.classList.remove("active"),g.classList.remove("active")},C=function(){var t=document.getElementsByClassName("counter");if(e={},t.length>0){for(var n=0;n<t.length;n++)t[n].id="counter-"+(n+1),e[n+1]={event:t[n].getElementsByClassName("event-name")[0].innerHTML,original:t[n].dataset.original,recurring:t[n].dataset.recurring};"active"===i.className&&(i.className="")}else i.className="active";k()},N=function(e,t,n,a,i){var o=document.createElement("li");return o.dataset.recurring=i,o.dataset.original=a,o.classList.add("counter"),cDate=moment(a).format("ddd, ll"),o.innerHTML='<a class="counter-delete transition" href="#"><i class="fa fa-times" aria-hidden="true"></i></a><h3 class="event-name">'+e+'</h3><span class="event-days">'+t+'</span><p class="event-type">'+n+'</p><span class="event-date">'+cDate+'</span><a class="counter-edit transition" href="#">Edit Counter</a>',s.appendChild(o),o},w=function(e){if(!/^\d{4}\-\d{2}\-\d{1,2}$/.test(e))return!1;var t=e.split("-"),n=parseInt(t[0]),a=parseInt(t[1]),s=parseInt(t[2]);if(n<1e3||n>3e3||a<=0||a>12)return!1;var i=[31,28,31,30,31,30,31,31,30,31,30,31];return(n%400===0||n%100!==0&&n%4===0)&&(i[1]=29),s>0&&s<=i[a-1]},T=function(e){var t=864e5,n=new Date;n.setHours(0,0,0,0),currentISO=n.toISOString();var a=new Date(e).toISOString(),s=new Date(currentISO),i=new Date(a),o={days:null,type:null};return i>s?(o.days=Math.round((i.getTime()-s.getTime())/t),o.type="Days Until"):(o.days=Math.round((s.getTime()-i.getTime())/t),o.type="Days Since"),0===o.days&&(o.days="Today",o.type="<br />"),o},k=function(){chrome.storage.sync.remove("counters",function(){chrome.storage.sync.set({counters:e},function(){console.log("Counters updated.")})})},O=function(){chrome.storage.sync.get("counters",function(e){for(var t in e.counters)if(e.counters.hasOwnProperty(t)){var n=e.counters[t],a={days:null,type:null,original:null};if(n.hasOwnProperty("recurring")||(n.recurring="none"),"none"!==n.recurring&&moment(n.original).isBefore(moment().startOf("day"))){var s=P(n.recurring,n.original);a={days:s.days,type:"Days Until",original:s.original}}else{var i=T(n.original);a={days:i.days,type:i.type,original:n.original}}N(n.event,a.days,a.type,a.original,n.recurring)}C(),S()})},S=function(){for(var e=document.getElementsByClassName("counter-edit"),t=document.getElementsByClassName("counter-delete"),n=0;n<e.length;n++)H(e[n]);for(var a=0;a<t.length;a++)V(t[a])},H=function(e){e.addEventListener("click",function(e){e.preventDefault(),n=this.parentNode,t=!0,M.setMoment(moment(n.dataset.original)),document.getElementById("modal-header-title").innerHTML="Edit Day Counter",document.getElementById("modal-submit").value="Save Day Counter",document.getElementById("event-name").value=n.getElementsByClassName("event-name")[0].innerHTML,document.getElementById("event-date").value=n.dataset.original,document.getElementById("event-recurring").value=n.dataset.recurring,r.classList.add("active")})},V=function(e){e.addEventListener("click",function(e){var t=this.parentNode;a=parseInt(t.id.split("-")[1]),y.classList.add("active")})},j=function(e){var t=document.getElementsByClassName("counter");if("undefined"!=typeof e.counterVisibility){for(var n=0;n<t.length;n++)t[n].classList.remove("disabled");if("future"===e.counterVisibility)for(var a=0;a<t.length;a++)t[a].getElementsByClassName("event-type")[0].innerHTML.indexOf("Since")!==-1&&t[a].classList.add("disabled");if("past"===e.counterVisibility)for(var s=0;s<t.length;s++)t[s].getElementsByClassName("event-type")[0].innerHTML.indexOf("Until")!==-1&&t[s].classList.add("disabled")}},x=function(){chrome.storage.sync.get("settings",function(e){"undefined"!=typeof e.settings&&(L.value=e.settings.counterSize,I.value=e.settings.counterScheme,"undefined"!=typeof e.settings.counterVisibility&&(h.value=e.settings.counterVisibility),document.documentElement.className=I.value,s.className=L.value,window.setTimeout(function(){document.documentElement.style.transition="0.5s ease all",document.body.style.transition="0.5s ease all"},500),j(e.settings))})},z=function(){chrome.storage.sync.remove("settings",function(){chrome.storage.sync.set({settings:settingsObj},function(){console.log("Settings updated."),x()})})},P=function(e,t){var n;if("weekly"===e)for(n=moment(t).add(1,"week").format("YYYY-MM-D");moment(n).isBefore(moment());)n=moment(n).add(1,"week").format("YYYY-MM-D");else if("biweekly"===e)for(n=moment(t).add(2,"week").format("YYYY-MM-D");moment(n).isBefore(moment());)n=moment(n).add(2,"week").format("YYYY-MM-D");else if("monthly"===e)for(n=moment(t).add(1,"month").format("YYYY-MM-D");moment(n).isBefore(moment());)n=moment(n).add(1,"month").format("YYYY-MM-D");else if("yearly"===e)for(n=moment(t).add(1,"year").format("YYYY-MM-D");moment(n).isBefore(moment());)n=moment(n).add(1,"year").format("YYYY-MM-D");var a=T(n);return{days:a.days,original:n}},U=function(){O(),x(),o.addEventListener("click",function(e){e.preventDefault(),M.gotoDate(new Date),r.classList.add("active"),document.getElementById("modal-header-title").innerHTML="Add a New Day Counter",document.getElementById("modal-submit").value="Add Day Counter",document.body.classList.add("active")}),d.addEventListener("click",function(e){e.preventDefault(),r.classList.remove("active"),D(),b(),document.body.classList.remove("active")}),l.addEventListener("click",function(){var e=c.value,a=m.value,s=u.value,i=!1;if(""===e||null===e?(v.classList.add("active"),i=!0):v.classList.remove("active"),""!==a&&null!==a&&w(a)?g.classList.remove("active"):(g.classList.add("active"),i=!0),!i){var o=T(a);if(t)n.getElementsByClassName("event-name")[0].innerHTML=e,n.getElementsByClassName("event-days")[0].innerHTML=o.days,n.getElementsByClassName("event-type")[0].innerHTML=o.type,n.getElementsByClassName("event-date")[0].innerHTML=moment(a).format("ddd, ll"),n.dataset.original=a,n.dataset.recurring=s,n=null,t=!1;else{var d=N(e,o.days,o.type,a,s);H(d.getElementsByClassName("counter-edit")[0]),V(d.getElementsByClassName("counter-delete")[0])}r.classList.remove("active"),document.body.classList.remove("active"),D(),b(),C()}}),E.addEventListener("click",function(e){e.preventDefault(),document.getElementById("counter-"+a).remove(),C(),y.classList.remove("active")}),f.addEventListener("click",function(e){e.preventDefault(),a=null,y.classList.remove("active")}),p.addEventListener("click",function(){this.classList.contains("active")?(this.classList.remove("active"),B.classList.remove("active")):(this.classList.add("active"),B.classList.add("active"))}),Y.addEventListener("click",function(e){e.preventDefault(),settingsObj={},settingsObj.counterSize=L.options[L.selectedIndex].value,settingsObj.counterScheme=I.options[I.selectedIndex].value,settingsObj.counterVisibility=h.options[h.selectedIndex].value,z()})};document.addEventListener("DOMContentLoaded",U)}();